# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è –ø—Ä–æ–µ–∫—Ç–∞ —Å MacBook –Ω–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

- `frontend/` - React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Vite)
- `backend/` - Node.js API (Express + TypeScript)
- `deploy-push.sh` - –°–∫—Ä–∏–ø—Ç –¥–ª—è push –≤ Git (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ MacBook)
- `deploy-server.sh` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ Ubuntu)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ù–∞ MacBook (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- Git
- Node.js >= 16
- npm

### –ù–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ
- Git
- Node.js >= 16
- npm
- PM2 (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–º)

## –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è

### –®–∞–≥ 1: Push –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å MacBook

```bash
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/sitemda

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
./deploy-push.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Git (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
2. –°–æ–∑–¥–∞–Ω–∏–µ .gitignore
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
5. Push –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤–∞—Å –ø–æ–ø—Ä–æ—Å—è—Ç:
- URL Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `git@github.com:username/sitemda.git`)
- –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ (–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### –®–∞–≥ 2: –î–µ–ø–ª–æ–π –Ω–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ

#### –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@your-server.com

# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone git@github.com:username/sitemda.git
cd sitemda

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤ Git)
# –°–æ–∑–¥–∞–π—Ç–µ backend/.env —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:
nano backend/.env
```

–ü—Ä–∏–º–µ—Ä `backend/.env`:
```env
NODE_ENV=production
PORT=50003
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
JWT_SECRET=your-secret-key
TELEGRAM_BOT_TOKEN=your-bot-token
# ... –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```

```bash
# –°–æ–∑–¥–∞–π—Ç–µ frontend/.env (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
nano frontend/.env
```

#### –î–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```bash
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/sitemda

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
./deploy-server.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:
1. ‚úÖ Git pull (–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
2. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend (`npm install`)
3. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend (`npm install`)
4. ‚úÖ –°–±–æ—Ä–∫–∞ backend (`npm run build`)
5. ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è slug –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
6. ‚úÖ –°–±–æ—Ä–∫–∞ frontend (`npm run build`)
7. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
8. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ PM2

### –†–µ–∂–∏–º—ã –∑–∞–ø—É—Å–∫–∞

#### Development —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
./deploy-server.sh
```
–ó–∞–ø—É—Å—Ç–∏—Ç:
- Backend: `npm run dev` –Ω–∞ –ø–æ—Ä—Ç—É 50003
- Frontend: `npm run dev` –Ω–∞ –ø–æ—Ä—Ç—É 50005

#### Production —Ä–µ–∂–∏–º
```bash
NODE_ENV=production ./deploy-server.sh
```
–ó–∞–ø—É—Å—Ç–∏—Ç:
- Backend: `npm run start:prod` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–π dist/)
- Frontend: —Å–æ–±–µ—Ä–µ—Ç –≤ `frontend/dist/` (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nginx/apache)

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PM2

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ PM2:

```bash
# –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 list

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
pm2 logs

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 logs backend-dev
pm2 logs frontend-dev

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
pm2 restart all
pm2 restart backend-dev

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
pm2 stop all
pm2 stop backend-dev

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 monit

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
pm2 save

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
pm2 startup
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –¥–ª—è Production

–î–ª—è production —Ä–µ–∂–∏–º–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è frontend:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # Frontend (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã)
    location / {
        root /path/to/sitemda/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:50003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
sudo nginx -t

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx
sudo systemctl restart nginx
```

## Troubleshooting

### –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull
```bash
# –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Å–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git reset --hard
git pull
```

### PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
pm2 delete all
pm2 start ecosystem.config.js
```

### –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
# –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
chmod +x deploy-push.sh deploy-server.sh
```

### Frontend –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
cd frontend
rm -rf node_modules package-lock.json
npm install
npm run build
```

## –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π

### –° MacBook:
```bash
./deploy-push.sh
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
./deploy-server.sh
```

–ì–æ—Ç–æ–≤–æ! üöÄ

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –¥–µ–ø–ª–æ–µ

### URL Redirects –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ç–æ–≤–∞—Ä–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö URL:

#### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `frontend/src/utils/urlRedirects.ts` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
- `URL_REDIRECTS_README.md` - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:

**Frontend:**
- `frontend/src/pages/CatalogHierarchicalV2.tsx` - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å—Ç–∞—Ä—ã—Ö –ø—É—Ç–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  - –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ slug (–¥–ª—è URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `pid`)
  - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π

**Backend:**
- `backend/src/controllers/catalogController.ts` - –£–ª—É—á—à–µ–Ω –ø–æ–∏—Å–∫ –ø–æ slug:
  - –°–Ω–∞—á–∞–ª–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  - Fallback: –ø–æ–∏—Å–∫ –ø–æ –Ω–∞—á–∞–ª—É slug (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö URL –±–µ–∑ shop_code)

**Deploy:**
- `deploy-server.sh` - –î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ slug –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

**–°—Ç–∞—Ä—ã–π URL —Ç–æ–≤–∞—Ä–∞:**
```
https://mda-medusa.ru/catalog/vape_industriya/kartridzhi_ispariteli/kartridzhi/product-slug/
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤:**
```
https://site.mda-platform.top/catalog/vape_industriya/kartridzhi_ispariteli_dlya_pod-sistem/kartridzhi/product-slug
```

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —Å–º. `URL_REDIRECTS_README.md`

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤:

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `frontend/src/utils/urlRedirects.ts`:
```typescript
export const categoryRedirects: Record<string, string> = {
  // –ë–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—É—Ç–∏ –ü–ï–†–í–´–ú–ò
  'old/specific/path': 'new/specific/path',
  'old/path': 'new/path',
};
```

### Sitemap –¥–ª—è SEO

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ XML sitemap:

#### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `backend/src/controllers/sitemapController.ts` - –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sitemap
- `backend/src/routes/sitemap.ts` - –†–æ—É—Ç—ã –¥–ª—è sitemap
- `SITEMAP_README.md` - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### –î–æ—Å—Ç—É–ø–Ω—ã–µ sitemap:
- `https://site.mda-platform.top/sitemap.xml` - –ì–ª–∞–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å
- `https://site.mda-platform.top/sitemap-static.xml` - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `https://site.mda-platform.top/sitemap-shops.xml` - –ú–∞–≥–∞–∑–∏–Ω—ã
- `https://site.mda-platform.top/sitemap-categories.xml` - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
- `https://site.mda-platform.top/sitemap-products.xml` - –¢–æ–≤–∞—Ä—ã (–¥–æ 10,000)
- `https://site.mda-platform.top/sitemap-iblock-11.xml` - Legacy —Ñ–æ—Ä–º–∞—Ç (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Å–∞–π—Ç–æ–º)

#### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
- –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ URL –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ç–æ–≤–∞—Ä–æ–≤
- Legacy –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö URL –º–∞–≥–∞–∑–∏–Ω–æ–≤

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —Å–º. `SITEMAP_README.md`

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ `backend/.env` —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL:
```env
FRONTEND_URL=https://site.mda-platform.top
```
