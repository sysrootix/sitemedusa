#!/bin/bash

# –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –¥–ª—è API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤

API_URL="https://site.mda-platform.top/api/auth/phone/send-code"

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤..."
echo "================================================"

# –ú–∞—Å—Å–∏–≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
declare -a test_phones=(
    "+7 (924) 407-37-47"
    "79244073747"
    "89244073747"
    "+79244073747"
    "9244073747"
    "+7 924 407 37 47"
    "8 (924) 407-37-47"
)

# –û–∂–∏–¥–∞–µ–º—ã–π –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
expected_normalized="79244073747"

echo "–û–∂–∏–¥–∞–µ–º—ã–π –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –≤ –ë–î: $expected_normalized"
echo ""

for phone in "${test_phones[@]}"; do
    echo "üì± –¢–µ—Å—Ç–∏—Ä—É–µ–º: '$phone'"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{\"phone\": \"$phone\"}" \
        "$API_URL")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
    if echo "$response" | grep -q '"success".*true'; then
        echo "‚úÖ –£—Å–ø–µ—Ö: $phone -> –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
    elif echo "$response" | grep -q '"success".*false'; then
        error_message=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
        echo "‚ùå –û—à–∏–±–∫–∞: $phone -> $error_message"
    else
        echo "‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: $response"
    fi
    
    echo ""
    sleep 1  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
done

echo "================================================"
echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:"
echo "- –í—Å–µ –Ω–æ–º–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç: $expected_normalized"
echo "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ users"
echo "- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ normalized_phone –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ: $expected_normalized"
